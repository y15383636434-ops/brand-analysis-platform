# 平台数据目录映射说明

## 概述

MediaCrawler的命令行参数和实际数据目录名可能不一致。本文档说明正确的映射关系，确保PyCharm和Web界面使用一致的数据目录。

## 映射关系

### 1. 用户界面代码 → MediaCrawler命令行参数 → 实际数据目录名

| 用户界面代码 | MediaCrawler命令行参数 | 实际数据目录名 | 说明 |
|------------|---------------------|--------------|------|
| `xhs` | `xhs` | `xhs` | 小红书：一致 |
| `douyin` | `dy` | `douyin` | 抖音：命令行用dy，目录用douyin |
| `weibo` | `wb` | `weibo` | 微博：命令行用wb，目录用weibo |
| `zhihu` | `zhihu` | `zhihu` | 知乎：一致 |
| `bilibili` | `bili` | `bili` | B站：命令行和目录都用bili |
| `kuaishou` | `ks` | `kuaishou` | 快手：命令行用ks，目录用kuaishou |
| `tieba` | `tieba` | `tieba` | 百度贴吧：一致 |

### 2. 关键映射配置

#### `MEDIACRAWLER_PLATFORM_MAP` (命令行参数映射)
```python
{
    "xhs": "xhs",        # 小红书
    "douyin": "dy",      # 抖音
    "weibo": "wb",       # 微博
    "zhihu": "zhihu",    # 知乎
    "bilibili": "bili",  # B站
    "kuaishou": "ks",    # 快手
    "tieba": "tieba",    # 百度贴吧
}
```

#### `MEDIACRAWLER_DATA_DIR_MAP` (数据目录映射)
```python
{
    "xhs": "xhs",              # 小红书：命令行和目录都是xhs
    "douyin": "douyin",        # 抖音：命令行用dy，但数据目录是douyin
    "weibo": "weibo",          # 微博：命令行用wb，但数据目录是weibo
    "zhihu": "zhihu",          # 知乎：命令行和目录都是zhihu
    "bilibili": "bili",        # B站：命令行用bili，数据目录也是bili
    "kuaishou": "kuaishou",    # 快手：命令行用ks，但数据目录是kuaishou
    "ks": "kuaishou",          # 快手（兼容ks代码）
    "tieba": "tieba",          # 百度贴吧：命令行和目录都是tieba
}
```

## 实际数据目录结构

```
MediaCrawler/data/
├── xhs/          # 小红书
│   └── json/
├── douyin/       # 抖音（不是dy）
│   └── json/
├── weibo/        # 微博（不是wb）
│   └── json/
├── zhihu/        # 知乎
│   └── json/
├── bili/         # B站（不是bilibili）
│   └── json/
└── kuaishou/     # 快手（不是ks）
    └── json/
```

## 代码使用规范

### 1. 启动爬取任务
使用 `MEDIACRAWLER_PLATFORM_MAP` 获取命令行参数：
```python
mediacrawler_platform = MEDIACRAWLER_PLATFORM_MAP.get(platform, platform)
cmd = ["python", "main.py", "--platform", mediacrawler_platform, ...]
```

### 2. 读取数据文件
使用 `get_actual_data_dir()` 函数获取实际数据目录：
```python
from app.api.v1.mediacrawler_ui import get_actual_data_dir

actual_data_dir = get_actual_data_dir(MEDIACRAWLER_PATH, platform)
data_dir = actual_data_dir / "json"
```

### 3. 统一配置位置
所有映射配置在 `app/api/v1/mediacrawler_ui.py` 中定义：
- `PLATFORM_MAP`: 用户界面显示名称
- `MEDIACRAWLER_PLATFORM_MAP`: MediaCrawler命令行参数映射
- `MEDIACRAWLER_DATA_DIR_MAP`: 实际数据目录名映射
- `get_actual_data_dir()`: 获取实际数据目录的函数

## 已修复的文件

1. ✅ `app/api/v1/mediacrawler_ui.py`
   - 修正了 `MEDIACRAWLER_DATA_DIR_MAP` 映射
   - 改进了 `get_actual_data_dir()` 函数

2. ✅ `app/api/v1/data_analysis.py`
   - 使用 `get_actual_data_dir()` 获取正确的数据目录
   - 修复了两处直接使用 `platform` 作为目录名的问题

## 注意事项

1. **不要直接使用平台代码作为目录名**
   - ❌ 错误：`data_dir = MEDIACRAWLER_PATH / "data" / platform / "json"`
   - ✅ 正确：`actual_data_dir = get_actual_data_dir(MEDIACRAWLER_PATH, platform)`

2. **命令行参数和数据目录名可能不同**
   - 快手：命令行用 `ks`，目录用 `kuaishou`
   - 抖音：命令行用 `dy`，目录用 `douyin`
   - 微博：命令行用 `wb`，目录用 `weibo`

3. **兼容性处理**
   - `get_actual_data_dir()` 函数会自动处理目录名变体
   - 如果标准目录不存在，会尝试其他可能的目录名

## 验证方法

运行以下命令检查实际目录结构：
```bash
python -c "from pathlib import Path; import json; data_dir = Path('MediaCrawler/data'); platforms = {d.name: len(list((d / 'json').glob('*.json'))) if (d / 'json').exists() else 0 for d in data_dir.iterdir() if d.is_dir() and not d.name.startswith('_')}; print(json.dumps(platforms, indent=2, ensure_ascii=False))"
```

预期输出应包含：
- `xhs`
- `douyin`（不是dy）
- `weibo`（不是wb）
- `bili`（不是bilibili）
- `kuaishou`（不是ks）



