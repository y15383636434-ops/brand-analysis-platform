<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æç»“æœ - {{ platform_name }}</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        
        .section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: none;
            padding-bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: '';
            display: block;
            width: 4px;
            height: 20px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            border-radius: 2px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: none;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-color: #cbd5e1;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }
        
        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .keyword-item {
            background: #f1f5f9;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            color: #334155;
            box-shadow: none;
            border: 1px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .keyword-item:hover {
            background: white;
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }
        
        .keyword-weight {
            color: #64748b;
            font-weight: 500;
            margin-left: 6px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .insights {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            line-height: 1.8;
            border: 1px solid #e2e8f0;
        }

        /* ä¼˜åŒ–AIæ´å¯Ÿæ ·å¼ */
        .insight-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }

        .insight-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-content {
            color: #475569;
            font-size: 15px;
        }

        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 10px;
            color: #475569;
        }

        .insight-list li::before {
            content: 'â€¢';
            position: absolute;
            left: 8px;
            color: #667eea;
            font-weight: bold;
        }

        
        .nav-links {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š åˆ†æç»“æœ</h1>
        <p class="subtitle">å¹³å°: {{ platform_name }}</p>
        
        <div id="resultContainer">
            <div class="loading">æ­£åœ¨åŠ è½½åˆ†æç»“æœ...</div>
        </div>
        
        <div class="nav-links">
            <a href="/api/v1/data-analysis">è¿”å›æ•°æ®åˆ†æ</a>
            <a href="/api/v1/mediacrawler">è¿”å›çˆ¬è™«æ§åˆ¶å°</a>
            <a href="/docs">APIæ–‡æ¡£</a>
        </div>
    </div>
    
    <script>
        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        // ä½¿ç”¨Jinja2è¾“å‡ºï¼Œä½†æ·»åŠ é»˜è®¤å€¼å¤„ç†ï¼Œé¿å…è¾“å‡º None
        const platform = "{{ platform or '' }}"; 
        const serverBrandId = "{{ brand_id or '' }}";
        const brandId = serverBrandId || urlParams.get('brand_id');
        const resultId = urlParams.get('result_id');

        console.log('Current Platform:', platform);
        console.log('Current Brand ID:', brandId);

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½å†å²è®°å½•åˆ—è¡¨ (ä¹Ÿä¼šæ ¹æ® URL å‚æ•°åŠ è½½å¯¹åº”å†…å®¹)
            loadHistoryList();
        });
        
        async function loadHistoryList() {
            const container = document.getElementById('resultContainer');
            
            try {
                // å¦‚æœæœ‰å“ç‰ŒIDï¼ŒåŠ è½½å“ç‰Œåˆ†æç»“æœ
                if (brandId) {
                    await loadBrandAnalysis(brandId, container);
                    return;
                }
                
                // å¦åˆ™åŠ è½½æ—§çš„åˆ†æç»“æœ
                let url = '/api/v1/data-analysis/result/list';
                
                // ä¼˜å…ˆä½¿ç”¨ result_id æŸ¥è¯¢
                if (resultId) {
                    url += `?result_id=${resultId}`;
                } else if (platform && platform !== 'None' && platform !== 'null') {
                    url += `?platform=${platform}`;
                }
                
                console.log('Fetching results from:', url); // Debug log
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.results && data.results.length > 0) {
                    // æ˜¾ç¤ºæœ€æ–°çš„ç»“æœ
                    const latestResult = data.results[0];
                    // å…¼å®¹å¤„ç†ï¼šç¡®ä¿ result å¯¹è±¡å­˜åœ¨
                    const result = latestResult.result || {};
                    const processedData = result.processed_data || { total_items: 0, total_texts: 0, total_comments: 0, file_count: 0 };
                    
                    console.log('åŠ è½½åˆ°æœ€æ–°åˆ†æç»“æœ:', latestResult);
                    
                    let html = '';
                    
                    // æ˜¾ç¤ºåˆ›å»ºæ—¶é—´
                    const createdDate = new Date(latestResult.created_at).toLocaleString();
                    html += `<div style="text-align: right; color: #666; margin-bottom: 20px; font-size: 14px;">ç”Ÿæˆæ—¶é—´: ${createdDate}</div>`;

                    // å¤„ç†æ•°æ®ç»Ÿè®¡
                    html += `
                        <div class="section">
                            <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value">${processedData.total_items}</div>
                                    <div class="stat-label">æ€»æ•°æ®é‡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${processedData.total_texts}</div>
                                    <div class="stat-label">æ–‡æœ¬æ•°é‡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${processedData.total_comments}</div>
                                    <div class="stat-label">è¯„è®ºæ•°é‡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${processedData.file_count}</div>
                                    <div class="stat-label">æ–‡ä»¶æ•°é‡</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // æƒ…æ„Ÿåˆ†æ
                    if (result.sentiment_analysis) {
                        const sentiment = result.sentiment_analysis;
                        html += `
                            <div class="section">
                                <h2>ğŸ˜Š æƒ…æ„Ÿåˆ†æ</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.positive_count}</div>
                                        <div class="stat-label">æ­£é¢ (${sentiment.distribution.positive}%)</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.negative_count}</div>
                                        <div class="stat-label">è´Ÿé¢ (${sentiment.distribution.negative}%)</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.neutral_count}</div>
                                        <div class="stat-label">ä¸­æ€§ (${sentiment.distribution.neutral}%)</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.avg_score.toFixed(2)}</div>
                                        <div class="stat-label">å¹³å‡æƒ…æ„Ÿåˆ†æ•°</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // å…³é”®è¯
                    if (result.keywords && result.keywords.length > 0) {
                        html += `
                            <div class="section">
                                <h2>ğŸ”‘ å…³é”®è¯åˆ†æ</h2>
                                <div class="keyword-list">
                        `;
                        result.keywords.forEach(kw => {
                            html += `
                                <div class="keyword-item">
                                    ${kw.keyword}
                                    <span class="keyword-weight">(${kw.weight.toFixed(3)})</span>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // LLMæ·±åº¦åˆ†æ
                    if (result.llm_insights && result.llm_insights.insights) {
                        const insights = result.llm_insights.insights;
                        let insightsHtml = '';
                        
                        console.log('LLM Insights Data:', insights); // Debug log

                        if (typeof insights === 'object' && insights !== null) {
                            // æ€»ä½“è¯„ä»· (å…¼å®¹ summary, overview æˆ–ç›´æ¥ä½œä¸ºå­—ç¬¦ä¸²)
                            let summaryText = insights.summary || insights.overview;
                            if (!summaryText && typeof insights === 'string') {
                                summaryText = insights;
                            }
                            
                            insightsHtml = `
                                <div class="insight-card">
                                    <div class="insight-title">
                                        <span style="font-size: 20px;">ğŸ’¡</span> æ€»ä½“è¯„ä»·
                                    </div>
                                    <div class="insight-content">
                                        ${summaryText || 'æš‚æ— æ‘˜è¦'}
                                    </div>
                                </div>
                            `;

                            // å¸‚åœºè¡¨ç° (SWOTä¸­çš„S/W)
                            if (insights.market_performance) {
                                insightsHtml += `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 15px;">
                                        <div class="insight-card" style="margin-bottom: 0;">
                                            <div class="insight-title" style="color: #059669;">
                                                <span style="font-size: 20px;">ğŸ’ª</span> å“ç‰Œä¼˜åŠ¿
                                            </div>
                                            <ul class="insight-list">
                                                ${(insights.market_performance.strengths || []).map(item => `<li>${item}</li>`).join('')}
                                            </ul>
                                        </div>
                                        <div class="insight-card" style="margin-bottom: 0;">
                                            <div class="insight-title" style="color: #dc2626;">
                                                <span style="font-size: 20px;">âš ï¸</span> å“ç‰ŒåŠ£åŠ¿
                                            </div>
                                            <ul class="insight-list">
                                                ${(insights.market_performance.weaknesses || []).map(item => `<li>${item}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                `;
                            }

                            // ç”¨æˆ·æ„ŸçŸ¥
                            if (insights.user_perception) {
                                insightsHtml += `
                                    <div class="insight-card">
                                        <div class="insight-title">
                                            <span style="font-size: 20px;">ğŸ—£ï¸</span> ç”¨æˆ·æ„ŸçŸ¥åˆ†æ
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
                                            <div>
                                                <h4 style="font-size: 15px; color: #d97706; margin-bottom: 12px; font-weight: 600;">ğŸ‘ ç”¨æˆ·å¥½è¯„ç‚¹</h4>
                                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                    ${(insights.user_perception.positive_points || []).map(item => `<span style="background: #fffbeb; color: #d97706; padding: 6px 12px; border-radius: 6px; font-size: 13px; border: 1px solid #fcd34d;">${item}</span>`).join('')}
                                                </div>
                                            </div>
                                            <div>
                                                <h4 style="font-size: 15px; color: #ef4444; margin-bottom: 12px; font-weight: 600;">ğŸ‘ ç”¨æˆ·ç—›ç‚¹/åæ§½</h4>
                                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                    ${(insights.user_perception.pain_points || insights.pain_points || []).map(item => `<span style="background: #fef2f2; color: #ef4444; padding: 6px 12px; border-radius: 6px; font-size: 13px; border: 1px solid #fca5a5;">${item}</span>`).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else if (insights.pain_points) {
                                // å…¼å®¹æ—§æ ¼å¼
                                insightsHtml += `
                                    <div class="insight-card">
                                        <div class="insight-title">
                                            <span style="font-size: 20px;">ğŸ˜£</span> ç”¨æˆ·ç—›ç‚¹
                                        </div>
                                        <ul class="insight-list">
                                            ${insights.pain_points.map(item => `<li>${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                `;
                            }

                            // æœºä¼šä¸å»ºè®®
                            insightsHtml += `
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                    <div class="insight-card" style="margin-bottom: 0; border-top: 4px solid #0ea5e9;">
                                        <div class="insight-title" style="color: #0284c7;">
                                            <span style="font-size: 20px;">ğŸš€</span> å¸‚åœºæœºä¼š
                                        </div>
                                        <ul class="insight-list">
                                            ${(insights.market_opportunities || []).map(item => `<li>${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="insight-card" style="margin-bottom: 0; border-top: 4px solid #8b5cf6;">
                                        <div class="insight-title" style="color: #7c3aed;">
                                            <span style="font-size: 20px;">ğŸ’¡</span> è¥é”€å»ºè®®
                                        </div>
                                        <ul class="insight-list">
                                            ${(insights.marketing_suggestions || []).map(item => `<li>${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            `;
                        } else {
                            // çº¯æ–‡æœ¬æ ¼å¼
                            insightsHtml = `<div class="insight-card"><div class="insight-content" style="white-space: pre-wrap;">${insights}</div></div>`;
                        }

                        html += `
                            <div class="section">
                                <h2>ğŸ¤– AIæ·±åº¦æ´å¯ŸæŠ¥å‘Š</h2>
                                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">${insightsHtml}</div>
                                ${result.llm_insights.model ? `<p style="margin-top: 15px; color: #94a3b8; font-size: 12px; text-align: right;">ç”Ÿæˆæ¨¡å‹: ${result.llm_insights.model}</p>` : ''}
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                } else {
                    console.log('æœªæ‰¾åˆ°åˆ†æç»“æœ:', data);
                    container.innerHTML = `
                        <div class="empty">
                            <h3>æš‚æ— åˆ†æç»“æœ</h3>
                            <p>æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„åˆ†æè®°å½•ã€‚</p>
                            <p>è¯·è¿”å›æ•°æ®åˆ†æé¡µé¢é‡æ–°ç”ŸæˆæŠ¥å‘Šã€‚</p>
                            <div style="margin-top: 20px;">
                                <a href="/api/v1/data-analysis" class="btn-primary" style="display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px;">
                                    å»ç”Ÿæˆåˆ†ææŠ¥å‘Š
                                </a>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»“æœå‡ºé”™:', error);
                container.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function loadBrandAnalysis(brandId, container) {
            try {
                // éªŒè¯brandId
                if (!brandId || isNaN(brandId)) {
                    throw new Error('æ— æ•ˆçš„å“ç‰ŒID');
                }
                
                // è·å–å“ç‰Œåˆ†æç»“æœï¼ˆåŒ…å«å›¾è¡¨ï¼‰
                const response = await fetch(`/api/v1/brands/${brandId}/analysis?include_charts=true`);
                
                // è§£æå“åº”æ•°æ®
                let data;
                try {
                    data = await response.json();
                    console.log('APIå“åº”æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
                } catch (e) {
                    // å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•è·å–æ–‡æœ¬
                    const text = await response.text();
                    console.error('JSONè§£æå¤±è´¥:', text);
                    throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${response.status} - ${text.substring(0, 100)}`);
                }
                
                // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
                if (!data || typeof data !== 'object') {
                    console.error('æ•°æ®æ ¼å¼é”™è¯¯:', data);
                    throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                // å¦‚æœHTTPçŠ¶æ€ä¸æ˜¯200ï¼Œä½†ä¹Ÿæ²¡æœ‰codeå­—æ®µï¼Œè¯´æ˜æ˜¯FastAPIçš„é»˜è®¤é”™è¯¯æ ¼å¼
                // è¿™ç§æƒ…å†µä¸‹ï¼Œå°†detailè½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                if (!response.ok && !data.code) {
                    console.log('æ£€æµ‹åˆ°FastAPIé»˜è®¤é”™è¯¯æ ¼å¼ï¼Œè½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼');
                    // å°†FastAPIçš„é»˜è®¤é”™è¯¯æ ¼å¼è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                    if (data.detail) {
                        // åˆ¤æ–­æ˜¯å¦æ˜¯"æš‚æ— åˆ†æç»“æœ"
                        if (data.detail.includes('æš‚æ— åˆ†æç»“æœ') || data.detail.includes('è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡')) {
                            data = {
                                code: 404,
                                message: data.detail,
                                data: {
                                    brand_id: brandId,
                                    message: data.detail
                                }
                            };
                        } else {
                            throw new Error(data.detail || data.message || `HTTPé”™è¯¯: ${response.status}`);
                        }
                    } else {
                        throw new Error(data.message || `HTTPé”™è¯¯: ${response.status}`);
                    }
                }
                
                // å¤„ç†ä¸åŒçš„å“åº”çŠ¶æ€
                console.log('å“åº”code:', data.code); // è°ƒè¯•ä¿¡æ¯
                if (data.code === 404) {
                    console.log('å¤„ç†404æƒ…å†µ'); // è°ƒè¯•ä¿¡æ¯
                    // æ²¡æœ‰åˆ†æç»“æœ
                    const brandName = data.data.brand_name || 'è¯¥å“ç‰Œ';
                    container.innerHTML = `
                        <div class="empty">
                            <h3>ğŸ“Š æš‚æ— åˆ†æç»“æœ</h3>
                            <p style="font-size: 16px; margin: 15px 0;">${data.data.message || `${brandName}è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨åˆ†æ`}</p>
                            <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin-bottom: 15px; color: #333;">å¼€å§‹åˆ†æ</h4>
                                <p style="margin-bottom: 15px; color: #666;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨åˆ†æä»»åŠ¡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ï¼š</p>
                                <ul style="text-align: left; display: inline-block; color: #666; margin-bottom: 20px;">
                                    <li>ä»æ•°æ®åº“è¯»å–å“ç‰Œç›¸å…³æ•°æ®</li>
                                    <li>è¿›è¡Œæƒ…æ„Ÿåˆ†æã€å…³é”®è¯æå–ã€ä¸»é¢˜åˆ†æ</li>
                                    <li>ä½¿ç”¨AIç”Ÿæˆæ·±åº¦æ´å¯Ÿ</li>
                                    <li>ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</li>
                                </ul>
                                <button onclick="startAnalysis(${brandId})" id="startAnalysisBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s;">
                                    å¯åŠ¨åˆ†æä»»åŠ¡
                                </button>
                                <div id="analysisStatus" style="margin-top: 15px; display: none;"></div>
                            </div>
                            <div style="margin-top: 20px;">
                                <a href="/api/v1/brands/${brandId}" style="color: #667eea; text-decoration: none; margin: 0 10px;">æŸ¥çœ‹å“ç‰Œè¯¦æƒ…</a>
                                <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none; margin: 0 10px;">è¿”å›æ•°æ®åˆ†æ</a>
                                <a href="/api/v1/brands" style="color: #667eea; text-decoration: none; margin: 0 10px;">å“ç‰Œåˆ—è¡¨</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (data.code === 202) {
                    // åˆ†æä»»åŠ¡è¿›è¡Œä¸­
                    const progress = data.data.progress || 0;
                    const progressBarId = `progress-bar-${brandId}`;
                    const progressTextId = `progress-text-${brandId}`;
                    
                    container.innerHTML = `
                        <div class="empty">
                            <h3>â³ åˆ†æä»»åŠ¡è¿›è¡Œä¸­</h3>
                            <p>åˆ†æä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                            <div style="margin: 20px 0;">
                                <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
                                    <div id="${progressBarId}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                                </div>
                                <p id="${progressTextId}" style="margin-top: 10px; color: #666;">è¿›åº¦: ${progress}%</p>
                            </div>
                            <p style="margin-top: 20px;">
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    æ‰‹åŠ¨åˆ·æ–°
                                </button>
                            </p>
                        </div>
                    `;
                    
                    // å¯åŠ¨è½®è¯¢ï¼Œæ¯3ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
                    if (!window.analysisPollingIntervals) {
                        window.analysisPollingIntervals = {};
                    }
                    
                    // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (window.analysisPollingIntervals[brandId]) {
                        clearInterval(window.analysisPollingIntervals[brandId]);
                    }
                    
                    // å¯åŠ¨æ–°çš„è½®è¯¢
                    window.analysisPollingIntervals[brandId] = setInterval(async () => {
                        try {
                            const pollResponse = await fetch(`/api/v1/brands/${brandId}/analysis?include_charts=true`);
                            const pollData = await pollResponse.json();
                            
                            if (pollData.code === 202) {
                                // ä»»åŠ¡ä»åœ¨è¿›è¡Œä¸­ï¼Œæ›´æ–°è¿›åº¦
                                const newProgress = pollData.data.progress || 0;
                                const progressBar = document.getElementById(progressBarId);
                                const progressText = document.getElementById(progressTextId);
                                
                                if (progressBar && progressText) {
                                    progressBar.style.width = `${newProgress}%`;
                                    progressText.textContent = `è¿›åº¦: ${newProgress}%`;
                                }
                            } else if (pollData.code === 200) {
                                // ä»»åŠ¡å®Œæˆï¼Œé‡æ–°åŠ è½½å®Œæ•´ç»“æœ
                                clearInterval(window.analysisPollingIntervals[brandId]);
                                delete window.analysisPollingIntervals[brandId];
                                await loadBrandAnalysis(brandId, container);
                            } else if (pollData.code === 404 || pollData.code === 500) {
                                // ä»»åŠ¡å¤±è´¥æˆ–å‡ºé”™ï¼Œåœæ­¢è½®è¯¢
                                clearInterval(window.analysisPollingIntervals[brandId]);
                                delete window.analysisPollingIntervals[brandId];
                                await loadBrandAnalysis(brandId, container);
                            }
                        } catch (error) {
                            console.error('è½®è¯¢æ›´æ–°è¿›åº¦å¤±è´¥:', error);
                            // å‡ºé”™æ—¶ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
                        }
                    }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
                    
                    return;
                }
                
                if (data.code === 500) {
                    // æœåŠ¡å™¨é”™è¯¯
                    throw new Error(data.data?.message || data.data?.error || 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                if (data.code !== 200) {
                    throw new Error(data.message || data.data?.error || data.data?.message || 'è·å–åˆ†æç»“æœå¤±è´¥');
                }
                
                if (!data.data) {
                    throw new Error('åˆ†æç»“æœæ•°æ®ä¸ºç©º');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                if (data.data.error) {
                    throw new Error(data.data.error);
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†æç»“æœ
                if (data.data.message && data.data.message === 'åˆ†æç»“æœæœªæ‰¾åˆ°') {
                    container.innerHTML = `
                        <div class="empty">
                            <h3>æš‚æ— åˆ†æç»“æœ</h3>
                            <p>è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨åˆ†æã€‚</p>
                            <p style="margin-top: 20px;">
                                <a href="/api/v1/brands/${brandId}" style="color: #667eea; text-decoration: none;">æŸ¥çœ‹å“ç‰Œè¯¦æƒ…</a> | 
                                <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none;">è¿”å›æ•°æ®åˆ†æ</a>
                            </p>
                        </div>
                    `;
                    return;
                }
                
                const analysisData = data.data;
                const result = analysisData.result || {};
                const charts = analysisData.charts || {};
                
                let html = '';
                
                // æŠ¥å‘Šæ‘˜è¦
                html += `
                    <div class="section">
                        <h2>ğŸ“Š æŠ¥å‘Šæ‘˜è¦</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${result.text_statistics?.total_count || 0}</div>
                                <div class="stat-label">æ€»æ–‡æœ¬æ•°</div>
                            </div>
                `;
                
                if (result.sentiment && result.sentiment.distribution) {
                    html += `
                            <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                                <div class="stat-value">${result.sentiment.distribution.positive.toFixed(1)}%</div>
                                <div class="stat-label">æ­£é¢æƒ…æ„Ÿ</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #F44336 0%, #d32f2f 100%); color: white;">
                                <div class="stat-value">${result.sentiment.distribution.negative.toFixed(1)}%</div>
                                <div class="stat-label">è´Ÿé¢æƒ…æ„Ÿ</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #FFC107 0%, #ffb300 100%); color: white;">
                                <div class="stat-value">${result.sentiment.distribution.neutral.toFixed(1)}%</div>
                                <div class="stat-label">ä¸­æ€§æƒ…æ„Ÿ</div>
                            </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                // æƒ…æ„Ÿåˆ†æå›¾è¡¨
                if (result.sentiment_analysis && result.sentiment_analysis.distribution) {
                    html += `
                        <div class="section">
                            <h2>ğŸ’­ æƒ…æ„Ÿåˆ†æåˆ†å¸ƒ</h2>
                            <div id="chartSentiment" style="width: 100%; height: 400px; margin-top: 20px;"></div>
                        </div>
                    `;
                } else if (charts.sentiment_pie) {
                    html += `
                        <div class="section">
                            <h2>ğŸ’­ æƒ…æ„Ÿåˆ†æåˆ†å¸ƒ</h2>
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.sentiment_pie}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="æƒ…æ„Ÿåˆ†å¸ƒå›¾">
                            </div>
                        </div>
                    `;
                }
                
                // å¹³å°å¯¹æ¯”å›¾
                // å³ä½¿åªæœ‰ä¸€ä¸ªå¹³å°ï¼Œä¹Ÿæ˜¾ç¤ºå›¾è¡¨ï¼Œæ–¹ä¾¿æŸ¥çœ‹
                if (result.platform_statistics && Object.keys(result.platform_statistics).length >= 1) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“± å¹³å°æ•°æ®åˆ†å¸ƒ</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                                <div>
                                    <h3 style="text-align: center; margin-bottom: 15px; color: #64748b; font-size: 16px;">å¹³å°å†…å®¹æ•°é‡å æ¯”</h3>
                                    <div id="chartPlatform" style="width: 100%; height: 350px;"></div>
                                </div>
                                <div>
                                    <h3 style="text-align: center; margin-bottom: 15px; color: #64748b; font-size: 16px;">å„å¹³å°æ•°æ®é‡ç»Ÿè®¡</h3>
                                    <div id="chartPlatformBar" style="width: 100%; height: 350px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (charts.sentiment_by_platform) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“± å„å¹³å°æƒ…æ„Ÿå¯¹æ¯”</h2>
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.sentiment_by_platform}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="å¹³å°å¯¹æ¯”å›¾">
                            </div>
                        </div>
                    `;
                }
                
                // è¶‹åŠ¿å›¾ (ç›®å‰APIæš‚æœªè¿”å›è¶‹åŠ¿æ•°æ®ï¼Œé¢„ç•™)
                if (charts.sentiment_trend) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“ˆ æƒ…æ„Ÿè¶‹åŠ¿åˆ†æ</h2>
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.sentiment_trend}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="è¶‹åŠ¿å›¾">
                            </div>
                        </div>
                    `;
                }
                
                // å…³é”®è¯
                if (result.keywords && result.keywords.length > 0) {
                    html += `
                        <div class="section">
                            <h2>ğŸ”‘ å…³é”®è¯åˆ†æ</h2>
                            <div id="chartKeywords" style="width: 100%; height: 400px; margin-top: 20px;"></div>
                    `;
                    if (charts.keywords_bar) {
                        html += `
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.keywords_bar}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="å…³é”®è¯å›¾">
                            </div>
                        `;
                    }
                    html += `
                            <div class="keyword-list">
                    `;
                    result.keywords.slice(0, 30).forEach(kw => {
                        html += `
                            <div class="keyword-item">
                                ${kw.keyword}
                                <span class="keyword-weight">(${kw.weight.toFixed(4)})</span>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // ä¸»é¢˜åˆ†æ
                if (result.topics && result.topics.length > 0) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“Œ ä¸»é¢˜åˆ†æ</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    `;
                    result.topics.forEach(topic => {
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="color: #667eea; margin-bottom: 10px;">${topic.topic}</h3>
                                <p style="color: #666; font-size: 12px; margin-bottom: 8px;">æƒé‡: ${topic.weight.toFixed(4)} | æ ·æœ¬æ•°: ${topic.sample_count}</p>
                                <p style="color: #999; font-size: 11px;">å…³é”®è¯: ${topic.keywords.join(', ')}</p>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // AIæ·±åº¦æ´å¯Ÿ
                if (result.llm_insights && result.llm_insights.insights) {
                    html += `
                        <div class="section">
                            <h2>ğŸ¤– AIæ·±åº¦æ´å¯Ÿ</h2>
                            <div class="insights">${result.llm_insights.insights}</div>
                            ${result.llm_insights.model ? `<p style="margin-top: 10px; color: #666; font-size: 12px;">ä½¿ç”¨æ¨¡å‹: ${result.llm_insights.model}</p>` : ''}
                        </div>
                    `;
                }
                
                // å¹³å°ç»Ÿè®¡
                if (result.platform_statistics) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“± å¹³å°æ•°æ®åˆ†å¸ƒ</h2>
                    `;
                    if (charts.platform_distribution) {
                        html += `
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.platform_distribution}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="å¹³å°åˆ†å¸ƒå›¾">
                            </div>
                        `;
                    }
                    html += `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    const platformNames = {
                        'xhs': 'å°çº¢ä¹¦',
                        'douyin': 'æŠ–éŸ³',
                        'weibo': 'å¾®åš',
                        'zhihu': 'çŸ¥ä¹',
                        'bilibili': 'Bç«™'
                    };
                    for (const [platform, stats] of Object.entries(result.platform_statistics)) {
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="color: #667eea; margin-bottom: 10px;">${platformNames[platform] || platform}</h3>
                                <p style="color: #666; font-size: 14px;">æ–‡æœ¬æ•°: ${stats.total_texts}</p>
                                <p style="color: #666; font-size: 14px;">å­—ç¬¦æ•°: ${stats.total_chars}</p>
                            </div>
                        `;
                    }
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // äº’åŠ¨æ•°æ®åˆ†æ
                if (result.interaction_statistics) {
                    const stats = result.interaction_statistics;
                    html += `
                        <div class="section">
                            <h2>ğŸ”¥ äº’åŠ¨æ•°æ®åˆ†æ</h2>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value">${stats.total_likes || 0}</div>
                                    <div class="stat-label">æ€»ç‚¹èµ</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${stats.total_comments || 0}</div>
                                    <div class="stat-label">æ€»è¯„è®º</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${stats.total_shares || 0}</div>
                                    <div class="stat-label">æ€»åˆ†äº«</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                                <div>
                                    <h3 style="text-align: center; margin-bottom: 15px; color: #666;">äº’åŠ¨æ„æˆ</h3>
                                    <div id="chartInteractionPie" style="width: 100%; height: 350px;"></div>
                                </div>
                                <div>
                                    <h3 style="text-align: center; margin-bottom: 15px; color: #666;">å„å¹³å°äº’åŠ¨å¯¹æ¯”</h3>
                                    <div id="chartInteractionBar" style="width: 100%; height: 350px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // æ“ä½œæŒ‰é’®
                html += `
                    <div class="section" style="text-align: center; padding: 20px;">
                        <a href="/api/v1/brands/${brandId}/analysis/view" style="display: inline-block; padding: 12px 24px; margin: 0 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
                            æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                        </a>
                        <a href="/api/v1/brands/${brandId}/reports?format=pdf" style="display: inline-block; padding: 12px 24px; margin: 0 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
                            ä¸‹è½½PDFæŠ¥å‘Š
                        </a>
                        <a href="/api/v1/brands/${brandId}/reports?format=md" target="_blank" style="display: inline-block; padding: 12px 24px; margin: 0 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
                            ä¸‹è½½MDæŠ¥å‘Š
                        </a>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // æ›´æ–°æ ‡é¢˜
                if (analysisData.brand_name) {
                    document.querySelector('h1').textContent = `${analysisData.brand_name} - åˆ†æç»“æœ`;
                }

                // æ¸²æŸ“å›¾è¡¨
                setTimeout(() => {
                    initCharts(result);
                }, 100);
                
            } catch (error) {
                console.error('åŠ è½½å“ç‰Œåˆ†æå¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                let errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                
                // å¦‚æœæ˜¯"æš‚æ— åˆ†æç»“æœ"æˆ–"è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡"ï¼Œæ˜¾ç¤ºå¯åŠ¨åˆ†æç•Œé¢
                if (errorMessage.includes('æš‚æ— åˆ†æç»“æœ') || 
                    errorMessage.includes('è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡') ||
                    errorMessage.includes('è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡')) {
                    const brandName = 'è¯¥å“ç‰Œ';
                    container.innerHTML = `
                        <div class="empty">
                            <h3>ğŸ“Š æš‚æ— åˆ†æç»“æœ</h3>
                            <p style="font-size: 16px; margin: 15px 0;">${brandName}è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨åˆ†æ</p>
                            <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin-bottom: 15px; color: #333;">å¼€å§‹åˆ†æ</h4>
                                <p style="margin-bottom: 15px; color: #666;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨åˆ†æä»»åŠ¡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ï¼š</p>
                                <ul style="text-align: left; display: inline-block; color: #666; margin-bottom: 20px;">
                                    <li>ä»æ•°æ®åº“è¯»å–å“ç‰Œç›¸å…³æ•°æ®</li>
                                    <li>è¿›è¡Œæƒ…æ„Ÿåˆ†æã€å…³é”®è¯æå–ã€ä¸»é¢˜åˆ†æ</li>
                                    <li>ä½¿ç”¨AIç”Ÿæˆæ·±åº¦æ´å¯Ÿ</li>
                                    <li>ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</li>
                                </ul>
                                <button onclick="startAnalysis(${brandId})" id="startAnalysisBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s;">
                                    å¯åŠ¨åˆ†æä»»åŠ¡
                                </button>
                                <div id="analysisStatus" style="margin-top: 15px; display: none;"></div>
                            </div>
                            <div style="margin-top: 20px;">
                                <a href="/api/v1/brands/${brandId}" style="color: #667eea; text-decoration: none; margin: 0 10px;">æŸ¥çœ‹å“ç‰Œè¯¦æƒ…</a>
                                <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none; margin: 0 10px;">è¿”å›æ•°æ®åˆ†æ</a>
                                <a href="/api/v1/brands" style="color: #667eea; text-decoration: none; margin: 0 10px;">å“ç‰Œåˆ—è¡¨</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (errorMessage.includes('404') || errorMessage.includes('å“ç‰Œä¸å­˜åœ¨')) {
                    errorMessage = 'å“ç‰Œä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥å“ç‰ŒIDæ˜¯å¦æ­£ç¡®';
                } else if (errorMessage.includes('æ— æ•ˆçš„å“ç‰ŒID')) {
                    errorMessage = 'å“ç‰ŒIDæ ¼å¼ä¸æ­£ç¡®';
                }
                
                container.innerHTML = `
                    <div class="empty">
                        <h3>âŒ åŠ è½½å¤±è´¥</h3>
                        <p style="color: #f44336; margin: 10px 0;">${errorMessage}</p>
                        <div style="margin-top: 20px;">
                            <p>å¯èƒ½çš„åŸå› ï¼š</p>
                            <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                                <li>å“ç‰ŒIDä¸å­˜åœ¨æˆ–æ— æ•ˆ</li>
                                <li>è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡</li>
                                <li>åˆ†æä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸­</li>
                                <li>æœåŠ¡å™¨è¿æ¥é—®é¢˜</li>
                            </ul>
                        </div>
                        <div style="margin-top: 20px;">
                            <button onclick="startAnalysis(${brandId})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px;">
                                å°è¯•å¯åŠ¨åˆ†æä»»åŠ¡
                            </button>
                            <a href="/api/v1/brands" style="color: #667eea; text-decoration: none; margin: 0 10px;">æŸ¥çœ‹å“ç‰Œåˆ—è¡¨</a>
                            <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none; margin: 0 10px;">è¿”å›æ•°æ®åˆ†æ</a>
                        </div>
                    </div>
                `;
            }
        }
        
        // å¯åŠ¨åˆ†æä»»åŠ¡
        async function startAnalysis(brandId) {
            const btn = document.getElementById('startAnalysisBtn');
            const statusDiv = document.getElementById('analysisStatus');
            const typeSelect = document.getElementById('analysisTypeSelect');
            const analysisType = typeSelect ? typeSelect.value : 'comprehensive';
            
            if (!btn || !statusDiv) return;
            
            btn.disabled = true;
            btn.textContent = 'æ­£åœ¨å¯åŠ¨...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #667eea;">æ­£åœ¨åˆ›å»ºåˆ†æä»»åŠ¡...</p>';
            
            try {
                const response = await fetch(`/api/v1/brands/${brandId}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis_type: analysisType,
                        include_sentiment: true,
                        include_topics: true,
                        include_keywords: true,
                        include_insights: true
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    statusDiv.innerHTML = `
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #4CAF50;">
                            <p style="color: #2e7d32; font-weight: 500;">âœ… åˆ†æä»»åŠ¡å·²å¯åŠ¨ï¼</p>
                            <p style="color: #666; font-size: 14px; margin-top: 5px;">ä»»åŠ¡ID: ${data.data.task_id}</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">åˆ†æä»»åŠ¡æ­£åœ¨åå°å¤„ç†ï¼Œè¯·ç¨å€™...</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">é¡µé¢å°†åœ¨5ç§’åè‡ªåŠ¨åˆ·æ–°</p>
                        </div>
                    `;
                    
                    // 5ç§’ååˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else {
                    throw new Error(data.message || 'å¯åŠ¨åˆ†æä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                console.error('å¯åŠ¨åˆ†æå¤±è´¥:', error);
                statusDiv.innerHTML = `
                    <div style="padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; font-weight: 500;">âŒ å¯åŠ¨å¤±è´¥</p>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">${error.message}</p>
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'é‡è¯•';
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰è½®è¯¢å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (window.analysisPollingIntervals) {
                for (const brandId in window.analysisPollingIntervals) {
                    clearInterval(window.analysisPollingIntervals[brandId]);
                }
                window.analysisPollingIntervals = {};
            }
        });

        // ECharts å›¾è¡¨æ¸²æŸ“å‡½æ•°
        function initCharts(result) {
            // æƒ…æ„Ÿåˆ†æé¥¼å›¾
            if (document.getElementById('chartSentiment') && result.sentiment_analysis) {
                const chart = echarts.init(document.getElementById('chartSentiment'));
                const sentiment = result.sentiment_analysis;
                chart.setOption({
                    tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                    legend: { bottom: '0%' },
                    color: ['#4CAF50', '#F44336', '#FFC107'],
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                        label: { show: false, position: 'center' },
                        emphasis: { label: { show: true, fontSize: 18, fontWeight: 'bold' } },
                        data: [
                            { value: sentiment.positive_count, name: 'æ­£é¢' },
                            { value: sentiment.negative_count, name: 'è´Ÿé¢' },
                            { value: sentiment.neutral_count, name: 'ä¸­æ€§' }
                        ]
                    }]
                });
            }

            // å¹³å°æ•°æ®åˆ†å¸ƒé¥¼å›¾
            if (document.getElementById('chartPlatform') && result.platform_statistics) {
                const chart = echarts.init(document.getElementById('chartPlatform'));
                const platformData = Object.entries(result.platform_statistics).map(([key, value]) => ({
                    name: formatPlatform(key),
                    value: value.total_texts
                }));
                
                chart.setOption({
                    tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                    legend: { bottom: '0%' },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                        data: platformData,
                        label: { show: true, position: 'inside', formatter: '{b}' },
                        emphasis: { label: { show: true, fontSize: 18, fontWeight: 'bold' } }
                    }]
                });
            }
            
            // å¹³å°æ•°æ®æŸ±çŠ¶å›¾
            if (document.getElementById('chartPlatformBar') && result.platform_statistics) {
                const chart = echarts.init(document.getElementById('chartPlatformBar'));
                const platforms = Object.keys(result.platform_statistics);
                const values = platforms.map(p => result.platform_statistics[p].total_texts);
                
                chart.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'category', data: platforms.map(formatPlatform), axisLabel: { interval: 0, rotate: 30 } },
                    yAxis: { type: 'value' },
                    series: [{
                        data: values,
                        type: 'bar',
                        itemStyle: { color: '#667eea', borderRadius: [4, 4, 0, 0] },
                        barWidth: '50%'
                    }]
                });
            }

            // å…³é”®è¯æŸ±çŠ¶å›¾
            if (document.getElementById('chartKeywords') && result.keywords && result.keywords.length > 0) {
                const chart = echarts.init(document.getElementById('chartKeywords'));
                const topKeywords = result.keywords.slice(0, 15);
                chart.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'value' },
                    yAxis: { type: 'category', data: topKeywords.map(k => k.keyword).reverse() },
                    series: [{
                        type: 'bar',
                        data: topKeywords.map(k => k.weight).reverse(),
                        itemStyle: { color: '#667eea', borderRadius: [0, 4, 4, 0] },
                        barWidth: '60%'
                    }]
                });
            }

            // äº’åŠ¨æ„æˆé¥¼å›¾
            if (document.getElementById('chartInteractionPie') && result.interaction_statistics) {
                const chart = echarts.init(document.getElementById('chartInteractionPie'));
                const stats = result.interaction_statistics;
                chart.setOption({
                    tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                    legend: { bottom: '0%' },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                        label: { show: true, position: 'inside', formatter: '{b}: {d}%' },
                        emphasis: { label: { show: true, fontSize: 18, fontWeight: 'bold' } },
                        data: [
                            { value: stats.total_likes, name: 'ç‚¹èµ' },
                            { value: stats.total_comments, name: 'è¯„è®º' },
                            { value: stats.total_shares, name: 'åˆ†äº«' }
                        ]
                    }]
                });
            }

            // å„å¹³å°äº’åŠ¨å¯¹æ¯”æŸ±çŠ¶å›¾
            if (document.getElementById('chartInteractionBar') && result.interaction_statistics && result.interaction_statistics.by_platform) {
                const chart = echarts.init(document.getElementById('chartInteractionBar'));
                const byPlatform = result.interaction_statistics.by_platform;
                const platforms = Object.keys(byPlatform);
                
                const likes = platforms.map(p => byPlatform[p].likes);
                const comments = platforms.map(p => byPlatform[p].comments);
                const shares = platforms.map(p => byPlatform[p].shares);
                
                chart.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    legend: { bottom: '0%' },
                    grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                    xAxis: { 
                        type: 'category', 
                        data: platforms.map(p => formatPlatform(p)),
                        axisLabel: { interval: 0, rotate: 30 }
                    },
                    yAxis: { type: 'value' },
                    series: [
                        { name: 'ç‚¹èµ', type: 'bar', data: likes, emphasis: { focus: 'series' } },
                        { name: 'è¯„è®º', type: 'bar', data: comments, emphasis: { focus: 'series' } },
                        { name: 'åˆ†äº«', type: 'bar', data: shares, emphasis: { focus: 'series' } }
                    ]
                });
            }

            // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜å›¾è¡¨
            window.addEventListener('resize', () => {
                echarts.getInstanceByDom(document.getElementById('chartSentiment'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartPlatform'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartPlatformBar'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartKeywords'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartInteractionPie'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartInteractionBar'))?.resize();
            });
        }

        function formatPlatform(key) {
            const map = { 
                'xhs': 'å°çº¢ä¹¦', 'douyin': 'æŠ–éŸ³', 'weibo': 'å¾®åš', 
                'zhihu': 'çŸ¥ä¹', 'bilibili': 'Bç«™', 'kuaishou': 'å¿«æ‰‹',
                'tieba': 'è´´å§'
            };
            return map[key] || key;
        }
    </script>
</body>
</html>





