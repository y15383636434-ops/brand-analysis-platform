<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æç»“æœ - {{ platform_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .keyword-item {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .keyword-weight {
            color: #667eea;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .insights {
            background: white;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .nav-links {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š åˆ†æç»“æœ</h1>
        <p class="subtitle">å¹³å°: {{ platform_name }}</p>
        
        <div id="resultContainer">
            <div class="loading">æ­£åœ¨åŠ è½½åˆ†æç»“æœ...</div>
        </div>
        
        <div class="nav-links">
            <a href="/api/v1/data-analysis">è¿”å›æ•°æ®åˆ†æ</a>
            <a href="/api/v1/mediacrawler">è¿”å›çˆ¬è™«æ§åˆ¶å°</a>
            <a href="/docs">APIæ–‡æ¡£</a>
        </div>
    </div>
    
    <script>
        const platform = '{{ platform }}';
        const urlParams = new URLSearchParams(window.location.search);
        const brandId = urlParams.get('brand_id');
        
        async function loadResults() {
            const container = document.getElementById('resultContainer');
            
            try {
                // å¦‚æœæœ‰å“ç‰ŒIDï¼ŒåŠ è½½å“ç‰Œåˆ†æç»“æœ
                if (brandId) {
                    await loadBrandAnalysis(brandId, container);
                    return;
                }
                
                // å¦åˆ™åŠ è½½æ—§çš„åˆ†æç»“æœ
                const url = platform 
                    ? `/api/v1/data-analysis/result/list?platform=${platform}`
                    : '/api/v1/data-analysis/result/list';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    // æ˜¾ç¤ºæœ€æ–°çš„ç»“æœ
                    const latestResult = data.results[0];
                    const result = latestResult.result;
                    
                    let html = '';
                    
                    // å¤„ç†æ•°æ®ç»Ÿè®¡
                    html += `
                        <div class="section">
                            <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value">${result.processed_data.total_items}</div>
                                    <div class="stat-label">æ€»æ•°æ®é‡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${result.processed_data.total_texts}</div>
                                    <div class="stat-label">æ–‡æœ¬æ•°é‡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${result.processed_data.total_comments}</div>
                                    <div class="stat-label">è¯„è®ºæ•°é‡</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${result.processed_data.file_count}</div>
                                    <div class="stat-label">æ–‡ä»¶æ•°é‡</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // æƒ…æ„Ÿåˆ†æ
                    if (result.sentiment_analysis) {
                        const sentiment = result.sentiment_analysis;
                        html += `
                            <div class="section">
                                <h2>ğŸ˜Š æƒ…æ„Ÿåˆ†æ</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.positive_count}</div>
                                        <div class="stat-label">æ­£é¢ (${sentiment.distribution.positive}%)</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.negative_count}</div>
                                        <div class="stat-label">è´Ÿé¢ (${sentiment.distribution.negative}%)</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.neutral_count}</div>
                                        <div class="stat-label">ä¸­æ€§ (${sentiment.distribution.neutral}%)</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">${sentiment.avg_score.toFixed(2)}</div>
                                        <div class="stat-label">å¹³å‡æƒ…æ„Ÿåˆ†æ•°</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // å…³é”®è¯
                    if (result.keywords && result.keywords.length > 0) {
                        html += `
                            <div class="section">
                                <h2>ğŸ”‘ å…³é”®è¯åˆ†æ</h2>
                                <div class="keyword-list">
                        `;
                        result.keywords.forEach(kw => {
                            html += `
                                <div class="keyword-item">
                                    ${kw.keyword}
                                    <span class="keyword-weight">(${kw.weight.toFixed(3)})</span>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // LLMæ·±åº¦åˆ†æ
                    if (result.llm_insights && result.llm_insights.insights) {
                        html += `
                            <div class="section">
                                <h2>ğŸ¤– AIæ·±åº¦åˆ†æ</h2>
                                <div class="insights">${result.llm_insights.insights}</div>
                                ${result.llm_insights.model ? `<p style="margin-top: 10px; color: #666; font-size: 12px;">ä½¿ç”¨æ¨¡å‹: ${result.llm_insights.model}</p>` : ''}
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty">æš‚æ— åˆ†æç»“æœ</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function loadBrandAnalysis(brandId, container) {
            try {
                // éªŒè¯brandId
                if (!brandId || isNaN(brandId)) {
                    throw new Error('æ— æ•ˆçš„å“ç‰ŒID');
                }
                
                // è·å–å“ç‰Œåˆ†æç»“æœï¼ˆåŒ…å«å›¾è¡¨ï¼‰
                const response = await fetch(`/api/v1/brands/${brandId}/analysis?include_charts=true`);
                
                // è§£æå“åº”æ•°æ®
                let data;
                try {
                    data = await response.json();
                    console.log('APIå“åº”æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
                } catch (e) {
                    // å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•è·å–æ–‡æœ¬
                    const text = await response.text();
                    console.error('JSONè§£æå¤±è´¥:', text);
                    throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯: ${response.status} - ${text.substring(0, 100)}`);
                }
                
                // æ£€æŸ¥å“åº”æ•°æ®æ ¼å¼
                if (!data || typeof data !== 'object') {
                    console.error('æ•°æ®æ ¼å¼é”™è¯¯:', data);
                    throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                // å¦‚æœHTTPçŠ¶æ€ä¸æ˜¯200ï¼Œä½†ä¹Ÿæ²¡æœ‰codeå­—æ®µï¼Œè¯´æ˜æ˜¯FastAPIçš„é»˜è®¤é”™è¯¯æ ¼å¼
                // è¿™ç§æƒ…å†µä¸‹ï¼Œå°†detailè½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                if (!response.ok && !data.code) {
                    console.log('æ£€æµ‹åˆ°FastAPIé»˜è®¤é”™è¯¯æ ¼å¼ï¼Œè½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼');
                    // å°†FastAPIçš„é»˜è®¤é”™è¯¯æ ¼å¼è½¬æ¢ä¸ºæˆ‘ä»¬çš„æ ¼å¼
                    if (data.detail) {
                        // åˆ¤æ–­æ˜¯å¦æ˜¯"æš‚æ— åˆ†æç»“æœ"
                        if (data.detail.includes('æš‚æ— åˆ†æç»“æœ') || data.detail.includes('è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡')) {
                            data = {
                                code: 404,
                                message: data.detail,
                                data: {
                                    brand_id: brandId,
                                    message: data.detail
                                }
                            };
                        } else {
                            throw new Error(data.detail || data.message || `HTTPé”™è¯¯: ${response.status}`);
                        }
                    } else {
                        throw new Error(data.message || `HTTPé”™è¯¯: ${response.status}`);
                    }
                }
                
                // å¤„ç†ä¸åŒçš„å“åº”çŠ¶æ€
                console.log('å“åº”code:', data.code); // è°ƒè¯•ä¿¡æ¯
                if (data.code === 404) {
                    console.log('å¤„ç†404æƒ…å†µ'); // è°ƒè¯•ä¿¡æ¯
                    // æ²¡æœ‰åˆ†æç»“æœ
                    const brandName = data.data.brand_name || 'è¯¥å“ç‰Œ';
                    container.innerHTML = `
                        <div class="empty">
                            <h3>ğŸ“Š æš‚æ— åˆ†æç»“æœ</h3>
                            <p style="font-size: 16px; margin: 15px 0;">${data.data.message || `${brandName}è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨åˆ†æ`}</p>
                            <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin-bottom: 15px; color: #333;">å¼€å§‹åˆ†æ</h4>
                                <p style="margin-bottom: 15px; color: #666;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨åˆ†æä»»åŠ¡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ï¼š</p>
                                <ul style="text-align: left; display: inline-block; color: #666; margin-bottom: 20px;">
                                    <li>ä»æ•°æ®åº“è¯»å–å“ç‰Œç›¸å…³æ•°æ®</li>
                                    <li>è¿›è¡Œæƒ…æ„Ÿåˆ†æã€å…³é”®è¯æå–ã€ä¸»é¢˜åˆ†æ</li>
                                    <li>ä½¿ç”¨AIç”Ÿæˆæ·±åº¦æ´å¯Ÿ</li>
                                    <li>ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</li>
                                </ul>
                                <button onclick="startAnalysis(${brandId})" id="startAnalysisBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s;">
                                    å¯åŠ¨åˆ†æä»»åŠ¡
                                </button>
                                <div id="analysisStatus" style="margin-top: 15px; display: none;"></div>
                            </div>
                            <div style="margin-top: 20px;">
                                <a href="/api/v1/brands/${brandId}" style="color: #667eea; text-decoration: none; margin: 0 10px;">æŸ¥çœ‹å“ç‰Œè¯¦æƒ…</a>
                                <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none; margin: 0 10px;">è¿”å›æ•°æ®åˆ†æ</a>
                                <a href="/api/v1/brands" style="color: #667eea; text-decoration: none; margin: 0 10px;">å“ç‰Œåˆ—è¡¨</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (data.code === 202) {
                    // åˆ†æä»»åŠ¡è¿›è¡Œä¸­
                    const progress = data.data.progress || 0;
                    const progressBarId = `progress-bar-${brandId}`;
                    const progressTextId = `progress-text-${brandId}`;
                    
                    container.innerHTML = `
                        <div class="empty">
                            <h3>â³ åˆ†æä»»åŠ¡è¿›è¡Œä¸­</h3>
                            <p>åˆ†æä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                            <div style="margin: 20px 0;">
                                <div style="background: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
                                    <div id="${progressBarId}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                                </div>
                                <p id="${progressTextId}" style="margin-top: 10px; color: #666;">è¿›åº¦: ${progress}%</p>
                            </div>
                            <p style="margin-top: 20px;">
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    æ‰‹åŠ¨åˆ·æ–°
                                </button>
                            </p>
                        </div>
                    `;
                    
                    // å¯åŠ¨è½®è¯¢ï¼Œæ¯3ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
                    if (!window.analysisPollingIntervals) {
                        window.analysisPollingIntervals = {};
                    }
                    
                    // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (window.analysisPollingIntervals[brandId]) {
                        clearInterval(window.analysisPollingIntervals[brandId]);
                    }
                    
                    // å¯åŠ¨æ–°çš„è½®è¯¢
                    window.analysisPollingIntervals[brandId] = setInterval(async () => {
                        try {
                            const pollResponse = await fetch(`/api/v1/brands/${brandId}/analysis?include_charts=true`);
                            const pollData = await pollResponse.json();
                            
                            if (pollData.code === 202) {
                                // ä»»åŠ¡ä»åœ¨è¿›è¡Œä¸­ï¼Œæ›´æ–°è¿›åº¦
                                const newProgress = pollData.data.progress || 0;
                                const progressBar = document.getElementById(progressBarId);
                                const progressText = document.getElementById(progressTextId);
                                
                                if (progressBar && progressText) {
                                    progressBar.style.width = `${newProgress}%`;
                                    progressText.textContent = `è¿›åº¦: ${newProgress}%`;
                                }
                            } else if (pollData.code === 200) {
                                // ä»»åŠ¡å®Œæˆï¼Œé‡æ–°åŠ è½½å®Œæ•´ç»“æœ
                                clearInterval(window.analysisPollingIntervals[brandId]);
                                delete window.analysisPollingIntervals[brandId];
                                await loadBrandAnalysis(brandId, container);
                            } else if (pollData.code === 404 || pollData.code === 500) {
                                // ä»»åŠ¡å¤±è´¥æˆ–å‡ºé”™ï¼Œåœæ­¢è½®è¯¢
                                clearInterval(window.analysisPollingIntervals[brandId]);
                                delete window.analysisPollingIntervals[brandId];
                                await loadBrandAnalysis(brandId, container);
                            }
                        } catch (error) {
                            console.error('è½®è¯¢æ›´æ–°è¿›åº¦å¤±è´¥:', error);
                            // å‡ºé”™æ—¶ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
                        }
                    }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
                    
                    return;
                }
                
                if (data.code === 500) {
                    // æœåŠ¡å™¨é”™è¯¯
                    throw new Error(data.data?.message || data.data?.error || 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                if (data.code !== 200) {
                    throw new Error(data.message || data.data?.error || data.data?.message || 'è·å–åˆ†æç»“æœå¤±è´¥');
                }
                
                if (!data.data) {
                    throw new Error('åˆ†æç»“æœæ•°æ®ä¸ºç©º');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                if (data.data.error) {
                    throw new Error(data.data.error);
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†æç»“æœ
                if (data.data.message && data.data.message === 'åˆ†æç»“æœæœªæ‰¾åˆ°') {
                    container.innerHTML = `
                        <div class="empty">
                            <h3>æš‚æ— åˆ†æç»“æœ</h3>
                            <p>è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨åˆ†æã€‚</p>
                            <p style="margin-top: 20px;">
                                <a href="/api/v1/brands/${brandId}" style="color: #667eea; text-decoration: none;">æŸ¥çœ‹å“ç‰Œè¯¦æƒ…</a> | 
                                <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none;">è¿”å›æ•°æ®åˆ†æ</a>
                            </p>
                        </div>
                    `;
                    return;
                }
                
                const analysisData = data.data;
                const result = analysisData.result || {};
                const charts = analysisData.charts || {};
                
                let html = '';
                
                // æŠ¥å‘Šæ‘˜è¦
                html += `
                    <div class="section">
                        <h2>ğŸ“Š æŠ¥å‘Šæ‘˜è¦</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${result.text_statistics?.total_count || 0}</div>
                                <div class="stat-label">æ€»æ–‡æœ¬æ•°</div>
                            </div>
                `;
                
                if (result.sentiment && result.sentiment.distribution) {
                    html += `
                            <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;">
                                <div class="stat-value">${result.sentiment.distribution.positive.toFixed(1)}%</div>
                                <div class="stat-label">æ­£é¢æƒ…æ„Ÿ</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #F44336 0%, #d32f2f 100%); color: white;">
                                <div class="stat-value">${result.sentiment.distribution.negative.toFixed(1)}%</div>
                                <div class="stat-label">è´Ÿé¢æƒ…æ„Ÿ</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #FFC107 0%, #ffb300 100%); color: white;">
                                <div class="stat-value">${result.sentiment.distribution.neutral.toFixed(1)}%</div>
                                <div class="stat-label">ä¸­æ€§æƒ…æ„Ÿ</div>
                            </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                // æƒ…æ„Ÿåˆ†æå›¾è¡¨
                if (charts.sentiment_pie) {
                    html += `
                        <div class="section">
                            <h2>ğŸ’­ æƒ…æ„Ÿåˆ†æåˆ†å¸ƒ</h2>
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.sentiment_pie}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="æƒ…æ„Ÿåˆ†å¸ƒå›¾">
                            </div>
                        </div>
                    `;
                }
                
                // å¹³å°å¯¹æ¯”å›¾
                if (charts.sentiment_by_platform) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“± å„å¹³å°æƒ…æ„Ÿå¯¹æ¯”</h2>
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.sentiment_by_platform}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="å¹³å°å¯¹æ¯”å›¾">
                            </div>
                        </div>
                    `;
                }
                
                // è¶‹åŠ¿å›¾
                if (charts.sentiment_trend) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“ˆ æƒ…æ„Ÿè¶‹åŠ¿åˆ†æ</h2>
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.sentiment_trend}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="è¶‹åŠ¿å›¾">
                            </div>
                        </div>
                    `;
                }
                
                // å…³é”®è¯
                if (result.keywords && result.keywords.length > 0) {
                    html += `
                        <div class="section">
                            <h2>ğŸ”‘ å…³é”®è¯åˆ†æ</h2>
                    `;
                    if (charts.keywords_bar) {
                        html += `
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.keywords_bar}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="å…³é”®è¯å›¾">
                            </div>
                        `;
                    }
                    html += `
                            <div class="keyword-list">
                    `;
                    result.keywords.slice(0, 30).forEach(kw => {
                        html += `
                            <div class="keyword-item">
                                ${kw.keyword}
                                <span class="keyword-weight">(${kw.weight.toFixed(4)})</span>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // ä¸»é¢˜åˆ†æ
                if (result.topics && result.topics.length > 0) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“Œ ä¸»é¢˜åˆ†æ</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    `;
                    result.topics.forEach(topic => {
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="color: #667eea; margin-bottom: 10px;">${topic.topic}</h3>
                                <p style="color: #666; font-size: 12px; margin-bottom: 8px;">æƒé‡: ${topic.weight.toFixed(4)} | æ ·æœ¬æ•°: ${topic.sample_count}</p>
                                <p style="color: #999; font-size: 11px;">å…³é”®è¯: ${topic.keywords.join(', ')}</p>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // AIæ·±åº¦æ´å¯Ÿ
                if (result.llm_insights && result.llm_insights.insights) {
                    html += `
                        <div class="section">
                            <h2>ğŸ¤– AIæ·±åº¦æ´å¯Ÿ</h2>
                            <div class="insights">${result.llm_insights.insights}</div>
                            ${result.llm_insights.model ? `<p style="margin-top: 10px; color: #666; font-size: 12px;">ä½¿ç”¨æ¨¡å‹: ${result.llm_insights.model}</p>` : ''}
                        </div>
                    `;
                }
                
                // å¹³å°ç»Ÿè®¡
                if (result.platform_statistics) {
                    html += `
                        <div class="section">
                            <h2>ğŸ“± å¹³å°æ•°æ®åˆ†å¸ƒ</h2>
                    `;
                    if (charts.platform_distribution) {
                        html += `
                            <div style="text-align: center; margin: 20px 0;">
                                <img src="data:image/png;base64,${charts.platform_distribution}" style="max-width: 100%; height: auto; border-radius: 8px;" alt="å¹³å°åˆ†å¸ƒå›¾">
                            </div>
                        `;
                    }
                    html += `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    `;
                    const platformNames = {
                        'xhs': 'å°çº¢ä¹¦',
                        'douyin': 'æŠ–éŸ³',
                        'weibo': 'å¾®åš',
                        'zhihu': 'çŸ¥ä¹',
                        'bilibili': 'Bç«™'
                    };
                    for (const [platform, stats] of Object.entries(result.platform_statistics)) {
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="color: #667eea; margin-bottom: 10px;">${platformNames[platform] || platform}</h3>
                                <p style="color: #666; font-size: 14px;">æ–‡æœ¬æ•°: ${stats.total_texts}</p>
                                <p style="color: #666; font-size: 14px;">å­—ç¬¦æ•°: ${stats.total_chars}</p>
                            </div>
                        `;
                    }
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // æ“ä½œæŒ‰é’®
                html += `
                    <div class="section" style="text-align: center; padding: 20px;">
                        <a href="/api/v1/brands/${brandId}/analysis/view" style="display: inline-block; padding: 12px 24px; margin: 0 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
                            æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                        </a>
                        <a href="/api/v1/brands/${brandId}/reports?format=pdf" style="display: inline-block; padding: 12px 24px; margin: 0 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 500;">
                            ä¸‹è½½PDFæŠ¥å‘Š
                        </a>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // æ›´æ–°æ ‡é¢˜
                if (analysisData.brand_name) {
                    document.querySelector('h1').textContent = `${analysisData.brand_name} - åˆ†æç»“æœ`;
                }
                
            } catch (error) {
                console.error('åŠ è½½å“ç‰Œåˆ†æå¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                let errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                
                // å¦‚æœæ˜¯"æš‚æ— åˆ†æç»“æœ"æˆ–"è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡"ï¼Œæ˜¾ç¤ºå¯åŠ¨åˆ†æç•Œé¢
                if (errorMessage.includes('æš‚æ— åˆ†æç»“æœ') || 
                    errorMessage.includes('è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡') ||
                    errorMessage.includes('è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡')) {
                    const brandName = 'è¯¥å“ç‰Œ';
                    container.innerHTML = `
                        <div class="empty">
                            <h3>ğŸ“Š æš‚æ— åˆ†æç»“æœ</h3>
                            <p style="font-size: 16px; margin: 15px 0;">${brandName}è¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡ï¼Œè¯·å…ˆå¯åŠ¨åˆ†æ</p>
                            <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin-bottom: 15px; color: #333;">å¼€å§‹åˆ†æ</h4>
                                <p style="margin-bottom: 15px; color: #666;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åŠ¨åˆ†æä»»åŠ¡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ï¼š</p>
                                <ul style="text-align: left; display: inline-block; color: #666; margin-bottom: 20px;">
                                    <li>ä»æ•°æ®åº“è¯»å–å“ç‰Œç›¸å…³æ•°æ®</li>
                                    <li>è¿›è¡Œæƒ…æ„Ÿåˆ†æã€å…³é”®è¯æå–ã€ä¸»é¢˜åˆ†æ</li>
                                    <li>ä½¿ç”¨AIç”Ÿæˆæ·±åº¦æ´å¯Ÿ</li>
                                    <li>ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</li>
                                </ul>
                                <button onclick="startAnalysis(${brandId})" id="startAnalysisBtn" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: transform 0.2s;">
                                    å¯åŠ¨åˆ†æä»»åŠ¡
                                </button>
                                <div id="analysisStatus" style="margin-top: 15px; display: none;"></div>
                            </div>
                            <div style="margin-top: 20px;">
                                <a href="/api/v1/brands/${brandId}" style="color: #667eea; text-decoration: none; margin: 0 10px;">æŸ¥çœ‹å“ç‰Œè¯¦æƒ…</a>
                                <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none; margin: 0 10px;">è¿”å›æ•°æ®åˆ†æ</a>
                                <a href="/api/v1/brands" style="color: #667eea; text-decoration: none; margin: 0 10px;">å“ç‰Œåˆ—è¡¨</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (errorMessage.includes('404') || errorMessage.includes('å“ç‰Œä¸å­˜åœ¨')) {
                    errorMessage = 'å“ç‰Œä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥å“ç‰ŒIDæ˜¯å¦æ­£ç¡®';
                } else if (errorMessage.includes('æ— æ•ˆçš„å“ç‰ŒID')) {
                    errorMessage = 'å“ç‰ŒIDæ ¼å¼ä¸æ­£ç¡®';
                }
                
                container.innerHTML = `
                    <div class="empty">
                        <h3>âŒ åŠ è½½å¤±è´¥</h3>
                        <p style="color: #f44336; margin: 10px 0;">${errorMessage}</p>
                        <div style="margin-top: 20px;">
                            <p>å¯èƒ½çš„åŸå› ï¼š</p>
                            <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                                <li>å“ç‰ŒIDä¸å­˜åœ¨æˆ–æ— æ•ˆ</li>
                                <li>è¯¥å“ç‰Œè¿˜æ²¡æœ‰å®Œæˆåˆ†æä»»åŠ¡</li>
                                <li>åˆ†æä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸­</li>
                                <li>æœåŠ¡å™¨è¿æ¥é—®é¢˜</li>
                            </ul>
                        </div>
                        <div style="margin-top: 20px;">
                            <button onclick="startAnalysis(${brandId})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 0 10px;">
                                å°è¯•å¯åŠ¨åˆ†æä»»åŠ¡
                            </button>
                            <a href="/api/v1/brands" style="color: #667eea; text-decoration: none; margin: 0 10px;">æŸ¥çœ‹å“ç‰Œåˆ—è¡¨</a>
                            <a href="/api/v1/data-analysis" style="color: #667eea; text-decoration: none; margin: 0 10px;">è¿”å›æ•°æ®åˆ†æ</a>
                        </div>
                    </div>
                `;
            }
        }
        
        // å¯åŠ¨åˆ†æä»»åŠ¡
        async function startAnalysis(brandId) {
            const btn = document.getElementById('startAnalysisBtn');
            const statusDiv = document.getElementById('analysisStatus');
            
            if (!btn || !statusDiv) return;
            
            btn.disabled = true;
            btn.textContent = 'æ­£åœ¨å¯åŠ¨...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #667eea;">æ­£åœ¨åˆ›å»ºåˆ†æä»»åŠ¡...</p>';
            
            try {
                const response = await fetch(`/api/v1/brands/${brandId}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis_type: 'full',
                        include_sentiment: true,
                        include_topics: true,
                        include_keywords: true,
                        include_insights: true
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    statusDiv.innerHTML = `
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #4CAF50;">
                            <p style="color: #2e7d32; font-weight: 500;">âœ… åˆ†æä»»åŠ¡å·²å¯åŠ¨ï¼</p>
                            <p style="color: #666; font-size: 14px; margin-top: 5px;">ä»»åŠ¡ID: ${data.data.task_id}</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">åˆ†æä»»åŠ¡æ­£åœ¨åå°å¤„ç†ï¼Œè¯·ç¨å€™...</p>
                            <p style="color: #666; font-size: 12px; margin-top: 10px;">é¡µé¢å°†åœ¨5ç§’åè‡ªåŠ¨åˆ·æ–°</p>
                        </div>
                    `;
                    
                    // 5ç§’ååˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else {
                    throw new Error(data.message || 'å¯åŠ¨åˆ†æä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                console.error('å¯åŠ¨åˆ†æå¤±è´¥:', error);
                statusDiv.innerHTML = `
                    <div style="padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; font-weight: 500;">âŒ å¯åŠ¨å¤±è´¥</p>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">${error.message}</p>
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'é‡è¯•';
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†æ‰€æœ‰è½®è¯¢å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (window.analysisPollingIntervals) {
                for (const brandId in window.analysisPollingIntervals) {
                    clearInterval(window.analysisPollingIntervals[brandId]);
                }
                window.analysisPollingIntervals = {};
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç»“æœ
        loadResults();
    </script>
</body>
</html>





