
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ç‰Œåˆ†ææŠ¥å‘Š</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.5;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: var(--card-bg);
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .brand-info h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
        }

        .brand-info .meta {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-outline {
            background-color: white;
            border-color: #e2e8f0;
            color: var(--text-main);
        }

        .btn-outline:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        /* Loading & Error */
        .state-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Summary Stats (Full Width) */
        .summary-stats {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-main);
        }

        .stat-trend {
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* AI Insight (Grid Layout) */
        .ai-insight-container {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .ai-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .ai-card.full-width {
            grid-column: span 2;
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 16px;
        }

        .ai-icon {
            margin-right: 8px;
            font-size: 20px;
        }

        .ai-content ul {
            padding-left: 20px;
            margin: 0;
        }
        
        .ai-content li {
            margin-bottom: 8px;
            color: #334155;
            font-size: 14px;
        }

        .ai-summary-text {
            color: #334155;
            line-height: 1.6;
            font-size: 15px;
        }

        /* Charts */
        .chart-section {
            height: 400px;
        }

        .col-span-8 { grid-column: span 8; }
        .col-span-4 { grid-column: span 4; }
        .col-span-6 { grid-column: span 6; }
        .col-span-12 { grid-column: span 12; }

        @media (max-width: 1024px) {
            .col-span-8, .col-span-4, .col-span-6, .ai-insight-container, .ai-card.full-width { 
                grid-column: span 12 !important; 
                grid-template-columns: 1fr;
            }
        }

        /* Top Posts Table */
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            font-weight: 600;
            color: var(--text-secondary);
            background-color: #f8fafc;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background-color: #f1f5f9;
        }

        .post-title {
            color: var(--text-main);
            font-weight: 500;
            text-decoration: none;
            display: block;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post-title:hover {
            color: var(--primary-color);
        }
        
        .platform-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .platform-xhs { background-color: #ff2442; }
        .platform-douyin { background-color: #000000; }
        .platform-weibo { background-color: #e6162d; }
        .platform-zhihu { background-color: #0084ff; }
        .platform-bilibili { background-color: #00a1d6; }
        .platform-other { background-color: #94a3b8; }

        .sentiment-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .sentiment-positive { background-color: #dcfce7; color: #166534; }
        .sentiment-negative { background-color: #fee2e2; color: #991b1b; }
        .sentiment-neutral { background-color: #f1f5f9; color: #475569; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="brand-info">
                <h1 id="brandName">å“ç‰Œåˆ†ææŠ¥å‘Š</h1>
                <div class="meta" id="metaInfo">åŠ è½½ä¸­...</div>
            </div>
            <div class="actions" id="actions" style="display: none;">
                <a href="javascript:history.back()" class="btn btn-outline">è¿”å›ä¸Šä¸€é¡µ</a>
                <!-- é¢„ç•™å¯¼å‡ºåŠŸèƒ½ -->
                <!-- <a href="#" class="btn btn-primary">å¯¼å‡ºæŠ¥å‘Š</a> -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="state-container">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="state-container" style="display: none;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ˜•</div>
            <h3 style="margin-bottom: 8px;">åŠ è½½å¤±è´¥</h3>
            <p id="errorMsg" style="color: var(--text-secondary);">æ— æ³•è·å–æ•°æ®</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="dashboard-grid" style="display: none;">
            
            <!-- 1. Key Metrics -->
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-label">æ€»å£°é‡ (Total Posts)</div>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-trend">å…¨ç½‘æ•°æ®é‡‡é›†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ­£é¢æƒ…æ„Ÿå æ¯”</div>
                    <div class="stat-value" style="color: var(--success);" id="statPositive">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">è´Ÿé¢æƒ…æ„Ÿå æ¯”</div>
                    <div class="stat-value" style="color: var(--danger);" id="statNegative">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æƒ…æ„Ÿå¾—åˆ†</div>
                    <div class="stat-value" id="statScore">0.0</div>
                    <div class="stat-trend">èŒƒå›´ 0 ~ 1</div>
                </div>
            </div>

            <!-- 2. AI Insight (Structured) -->
            <div class="ai-insight-container">
                <div class="ai-card full-width" style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); border-color: #bae6fd;">
                    <div class="ai-card-header" style="color: #0369a1;">
                        <span class="ai-icon">ğŸ¤–</span> æ€»ä½“è¯„ä»·ä¸åˆ†æ
                    </div>
                    <div class="ai-content ai-summary-text" id="aiSummary">æ­£åœ¨åˆ†æ...</div>
                </div>
                
                <div class="ai-card">
                    <div class="ai-card-header" style="color: #b91c1c;">
                        <span class="ai-icon">âš¡</span> ç”¨æˆ·ä¸»è¦ç—›ç‚¹
                    </div>
                    <div class="ai-content" id="aiPainPoints">
                        <ul><li>æš‚æ— æ•°æ®</li></ul>
                    </div>
                </div>
                
                <div class="ai-card">
                    <div class="ai-card-header" style="color: #15803d;">
                        <span class="ai-icon">ğŸ’¡</span> è¥é”€å»ºè®®
                    </div>
                    <div class="ai-content" id="aiSuggestions">
                         <ul><li>æš‚æ— æ•°æ®</li></ul>
                    </div>
                </div>
            </div>

            <!-- 3. Charts Row 1 -->
            <div class="card col-span-4 chart-section">
                <div class="card-header">
                    <div class="card-title">æƒ…æ„Ÿåˆ†å¸ƒ</div>
                </div>
                <div id="chartSentiment" style="width: 100%; height: 320px;"></div>
            </div>

            <div class="card col-span-8 chart-section">
                <div class="card-header">
                    <div class="card-title">æƒ…æ„Ÿè¶‹åŠ¿èµ°åŠ¿</div>
                </div>
                <div id="chartTrend" style="width: 100%; height: 320px;"></div>
            </div>

            <!-- 4. Top Posts (Table) -->
            <div class="card col-span-12">
                <div class="card-header">
                    <div class="card-title">ğŸ”¥ çƒ­é—¨å†…å®¹æº¯æº (Top 20)</div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å†…å®¹æ ‡é¢˜</th>
                                <th>å¹³å°</th>
                                <th>äº’åŠ¨æŒ‡æ•°</th>
                                <th>ç‚¹èµæ•°</th>
                                <th>è¯„è®ºæ•°</th>
                                <th>æƒ…æ„Ÿå€¾å‘</th>
                            </tr>
                        </thead>
                        <tbody id="topPostsTableBody">
                            <!-- JS æ¸²æŸ“ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 5. Charts Row 2 -->
            <div class="card col-span-6 chart-section">
                <div class="card-header">
                    <div class="card-title">å¹³å°å£°é‡åˆ†å¸ƒ</div>
                </div>
                <div id="chartPlatform" style="width: 100%; height: 320px;"></div>
            </div>

            <div class="card col-span-6 chart-section">
                <div class="card-header">
                    <div class="card-title">æ ¸å¿ƒå…³é”®è¯æƒé‡</div>
                </div>
                <div id="chartKeywords" style="width: 100%; height: 320px;"></div>
            </div>
        </div>
    </div>

    <script>
        // è·å–å“ç‰ŒID
        // ä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“çš„IDï¼Œå¦‚æœä¸ºç©ºåˆ™å°è¯•ä»URLå‚æ•°è·å–
        // æ³¨æ„ï¼šä½¿ç”¨å¼•å·åŒ…è£¹æ¨¡æ¿å˜é‡ï¼Œç¡®ä¿å³ä½¿æ˜¯æ•°å­—ä¹Ÿè¢«è§†ä¸ºå­—ç¬¦ä¸²
        const serverBrandId = "{{ brand_id or '' }}";
        const urlParams = new URLSearchParams(window.location.search);
        
        // æ£€æŸ¥ serverBrandId æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ ID (ä¸æ˜¯æ¨¡æ¿å ä½ç¬¦ä¸”ä¸ä¸ºNone)
        // æ³¨æ„ï¼šJinja2 æ¸²æŸ“æ—¶å¦‚æœå˜é‡ä¸º Noneï¼Œä¼šè¾“å‡º 'None' å­—ç¬¦ä¸²
        // ä½¿ç”¨ '{' + '{' é¿å…è¢« Jinja2 è§£æä¸ºæ¨¡æ¿æ ‡ç­¾
        const isServerIdValid = serverBrandId && !serverBrandId.includes('{' + '{') && serverBrandId !== 'None';
        
        const brandId = isServerIdValid ? serverBrandId : (urlParams.get('brand_id') || urlParams.get('id'));

        if (!brandId) {
            showError('æœªæ‰¾åˆ°å“ç‰Œ ID');
        } else {
            console.log('Current Brand ID:', brandId);
            loadData();
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'flex';
            document.getElementById('errorMsg').textContent = msg;
        }

        async function loadData() {
            try {
                // è¯·æ±‚æ•°æ®
                const response = await fetch(`/api/v1/brands/${brandId}/analysis?include_charts=false`);
                const res = await response.json();

                // å¤„ç†æœªæ‰¾åˆ°åˆ†æç»“æœçš„æƒ…å†µ (404)
                if (res.code === 404) {
                    showEmptyState(res.message);
                    return;
                }

                if (res.code !== 200 && res.code !== 202) {
                    throw new Error(res.message || 'è·å–æ•°æ®å¤±è´¥');
                }
                
                // å¤„ç†è¿›è¡Œä¸­çš„çŠ¶æ€
                if (res.code === 202) {
                    document.getElementById('loading').innerHTML = `
                        <div class="loading-spinner"></div>
                        <p>åˆ†æä»»åŠ¡è¿›è¡Œä¸­...å½“å‰è¿›åº¦ ${res.data.progress}%</p>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">è¯·ç¨å€™ï¼Œé¡µé¢ä¼šè‡ªåŠ¨åˆ·æ–°</p>
                    `;
                    setTimeout(loadData, 3000); // 3ç§’åè½®è¯¢
                    return;
                }

                const data = res.data;
                const result = data.result || {};
                
                // æ¸²æŸ“é¡µé¢
                renderHeader(data);
                renderSummary(result);
                renderAIInsight(result);
                renderTopPosts(result.top_posts || []);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';
                document.getElementById('actions').style.display = 'flex';

                // åˆå§‹åŒ–å›¾è¡¨
                setTimeout(() => {
                    initCharts(result);
                }, 100);

            } catch (error) {
                console.error(error);
                showError(error.message);
            }
        }

        function showEmptyState(msg) {
            document.getElementById('loading').style.display = 'none';
            const errorContainer = document.getElementById('error');
            errorContainer.style.display = 'flex';
            errorContainer.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“Š</div>
                <h3 style="margin-bottom: 8px;">æš‚æ— åˆ†ææŠ¥å‘Š</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">${msg || 'è¯¥å“ç‰Œè¿˜æ²¡æœ‰è¿›è¡ŒAIæ·±åº¦åˆ†æ'}</p>
                
                <div style="margin-bottom: 16px;">
                    <select id="analysisTypeSelect" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #e2e8f0; margin-right: 8px;">
                        <option value="comprehensive">å…¨æ–¹ä½æ·±åº¦åˆ†æ (é»˜è®¤)</option>
                        <option value="marketing_strategy">è¥é”€ç­–ç•¥åˆ†æ</option>
                        <option value="product_feedback">äº§å“åé¦ˆåˆ†æ</option>
                        <option value="crisis_detection">èˆ†æƒ…é£é™©åˆ†æ</option>
                    </select>
                </div>

                <button onclick="startAnalysis()" class="btn btn-primary" style="padding: 10px 24px;">ğŸš€ ç«‹å³å¯åŠ¨åˆ†æ</button>
            `;
        }

        async function startAnalysis() {
            const typeSelect = document.getElementById('analysisTypeSelect');
            const analysisType = typeSelect ? typeSelect.value : 'comprehensive';
            const typeName = typeSelect ? typeSelect.options[typeSelect.selectedIndex].text : 'æ·±åº¦åˆ†æ';

            if (!confirm(`ç¡®å®šè¦å¯åŠ¨ ${typeName} å—ï¼Ÿ\n\nè¿™å°†åŸºäºå·²å…³è”çš„æ•°æ®ç”ŸæˆæŠ¥å‘Šï¼Œè€—æ—¶çº¦1-3åˆ†é’Ÿã€‚`)) return;
            
            try {
                document.getElementById('error').style.display = 'none';
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('loading').innerHTML = '<div class="loading-spinner"></div><p>æ­£åœ¨å¯åŠ¨åˆ†æä»»åŠ¡...</p>';
                
                const response = await fetch(`/api/v1/brands/${brandId}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        analysis_type: analysisType,
                        include_sentiment: true,
                        include_topics: true,
                        include_keywords: true,
                        include_insights: true
                    })
                });
                
                const data = await response.json();
                if (data.code === 200) {
                    // é‡æ–°åŠ è½½ï¼Œå°†è¿›å…¥ 202 ç­‰å¾…çŠ¶æ€
                    loadData();
                } else {
                    showError('å¯åŠ¨å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                showError('å¯åŠ¨å¤±è´¥: ' + e.message);
            }
        }

        function renderHeader(data) {
            document.getElementById('brandName').textContent = `${data.brand_name} æ·±åº¦åˆ†ææŠ¥å‘Š`;
            document.getElementById('metaInfo').textContent = `ç”Ÿæˆæ—¶é—´: ${data.generated_at || 'åˆšåˆš'}`;
        }

        function renderSummary(result) {
            const stats = result.text_statistics || {};
            const sentiment = result.sentiment || {};
            
            document.getElementById('statTotal').textContent = (stats.total_count || 0).toLocaleString();
            
            if (sentiment.distribution) {
                document.getElementById('statPositive').textContent = sentiment.distribution.positive.toFixed(1) + '%';
                document.getElementById('statNegative').textContent = sentiment.distribution.negative.toFixed(1) + '%';
            }
            
            document.getElementById('statScore').textContent = (sentiment.avg_score || 0).toFixed(2);
        }

        function renderAIInsight(result) {
            const insights = result.llm_insights || {};
            let content = insights.insights || {};
            
            // å…¼å®¹æ—§ç‰ˆéç»“æ„åŒ–æ•°æ®
            if (typeof content === 'string') {
                document.getElementById('aiSummary').textContent = content;
                document.getElementById('aiPainPoints').innerHTML = '<p style="color:#999">æ•°æ®æ ¼å¼æ—§ï¼Œæ— æ³•æ‹†åˆ†æ˜¾ç¤º</p>';
                document.getElementById('aiSuggestions').innerHTML = '<p style="color:#999">æ•°æ®æ ¼å¼æ—§ï¼Œæ— æ³•æ‹†åˆ†æ˜¾ç¤º</p>';
                return;
            }

            // æ¸²æŸ“ç»“æ„åŒ–æ•°æ®
            document.getElementById('aiSummary').textContent = content.summary || 'æš‚æ— æ€»ä½“è¯„ä»·';
            
            // å¸‚åœºè¡¨ç° (å¦‚æœæœ‰)
            if (content.market_performance) {
                // å¦‚æœéœ€è¦æ˜¾ç¤ºæ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰©å±•ï¼Œç›®å‰ä»…æ˜¾ç¤ºç—›ç‚¹å’Œå»ºè®®
            }
            
            // ç”¨æˆ·ç—›ç‚¹/æ­£é¢è¯„ä»·
            const painPoints = content.pain_points || 
                              (content.user_perception ? content.user_perception.pain_points : []) ||
                              (content.product_perception ? content.product_perception.cons : []);
            renderList('aiPainPoints', painPoints);

            // è¥é”€å»ºè®®/å†…å®¹å»ºè®®
            const suggestions = content.marketing_suggestions || 
                               content.suggestions || 
                               (content.content_strategy ? content.content_strategy.content_recommendations : []) ||
                               (content.improvement_suggestions ? content.improvement_suggestions : []);
            renderList('aiSuggestions', suggestions);
            
            // å¦‚æœæœ‰é¢å¤–çš„å†…å®¹ç­–ç•¥å»ºè®®ï¼Œè¿½åŠ æ˜¾ç¤º
            if (content.content_strategy && content.content_strategy.engaging_topics) {
                 // å¯ä»¥è€ƒè™‘åœ¨é¡µé¢ä¸Šå¢åŠ ä¸€ä¸ªåŒºåŸŸæ˜¾ç¤ºçƒ­é—¨è¯é¢˜ï¼Œæˆ–è€…åˆå¹¶åˆ°å»ºè®®ä¸­
            }
        }

        function renderList(elementId, items) {
            const container = document.getElementById(elementId);
            if (!items || items.length === 0) {
                container.innerHTML = '<p style="color:#999; font-size: 14px;">æš‚æ— ç›¸å…³å†…å®¹</p>';
                return;
            }
            
            const ul = document.createElement('ul');
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                ul.appendChild(li);
            });
            container.innerHTML = '';
            container.appendChild(ul);
        }

        function renderTopPosts(posts) {
            const tbody = document.getElementById('topPostsTableBody');
            tbody.innerHTML = '';
            
            if (!posts || posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">æš‚æ— çƒ­é—¨å†…å®¹æ•°æ®</td></tr>';
                return;
            }

            posts.forEach(post => {
                const tr = document.createElement('tr');
                
                // æƒ…æ„Ÿå¾½ç« 
                let sentimentClass = 'sentiment-neutral';
                let sentimentText = 'ä¸­æ€§';
                if (post.sentiment) {
                    if (post.sentiment.sentiment === 'positive') { sentimentClass = 'sentiment-positive'; sentimentText = 'æ­£é¢'; }
                    else if (post.sentiment.sentiment === 'negative') { sentimentClass = 'sentiment-negative'; sentimentText = 'è´Ÿé¢'; }
                }

                // å¹³å°å¾½ç« 
                const platformMap = {
                    'xhs': { name: 'å°çº¢ä¹¦', cls: 'platform-xhs' },
                    'douyin': { name: 'æŠ–éŸ³', cls: 'platform-douyin' },
                    'weibo': { name: 'å¾®åš', cls: 'platform-weibo' },
                    'zhihu': { name: 'çŸ¥ä¹', cls: 'platform-zhihu' },
                    'bilibili': { name: 'Bç«™', cls: 'platform-bilibili' }
                };
                const pInfo = platformMap[post.platform] || { name: post.platform, cls: 'platform-other' };

                tr.innerHTML = `
                    <td>
                        <a href="${post.url || '#'}" target="_blank" class="post-title" title="${post.title || post.content}">
                            ${post.title || 'æ— æ ‡é¢˜'}
                        </a>
                    </td>
                    <td><span class="platform-tag ${pInfo.cls}">${pInfo.name}</span></td>
                    <td><span style="font-weight:bold; color:#f59e0b;">${post.score || 0}</span></td>
                    <td>${(post.likes || 0).toLocaleString()}</td>
                    <td>${(post.comments_count || 0).toLocaleString()}</td>
                    <td><span class="sentiment-badge ${sentimentClass}">${sentimentText}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function initCharts(result) {
            // ECharts é…ç½®ä¸ä¹‹å‰ç›¸åŒï¼Œç•¥å¾®ä¼˜åŒ–æ ·å¼
            const sentiment = result.sentiment || {};
            if (sentiment.distribution) {
                const chart = echarts.init(document.getElementById('chartSentiment'));
                chart.setOption({
                    tooltip: { trigger: 'item' },
                    legend: { bottom: '0%' },
                    color: ['#10b981', '#ef4444', '#f59e0b'],
                    series: [{
                        type: 'pie',
                        radius: ['45%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                        label: { show: false, position: 'center' },
                        emphasis: { label: { show: true, fontSize: 18, fontWeight: 'bold' } },
                        data: [
                            { value: sentiment.distribution.positive, name: 'æ­£é¢' },
                            { value: sentiment.distribution.negative, name: 'è´Ÿé¢' },
                            { value: sentiment.distribution.neutral, name: 'ä¸­æ€§' }
                        ]
                    }]
                });
            }

            // æƒ…æ„Ÿè¶‹åŠ¿
            const timeData = sentiment.by_time?.distribution || [];
            if (timeData.length > 0) {
                const chart = echarts.init(document.getElementById('chartTrend'));
                chart.setOption({
                    tooltip: { trigger: 'axis' },
                    legend: { bottom: 0 },
                    grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                    xAxis: { type: 'category', boundaryGap: false, data: timeData.map(i => i.date) },
                    yAxis: { type: 'value' },
                    color: ['#10b981', '#ef4444', '#f59e0b'],
                    series: [
                        { name: 'æ­£é¢', type: 'line', smooth: true, showSymbol: false, data: timeData.map(i => i.positive) },
                        { name: 'è´Ÿé¢', type: 'line', smooth: true, showSymbol: false, data: timeData.map(i => i.negative) },
                        { name: 'ä¸­æ€§', type: 'line', smooth: true, showSymbol: false, data: timeData.map(i => i.neutral) }
                    ]
                });
            }

            // å¹³å°åˆ†å¸ƒ
            const platforms = result.platform_statistics || {};
            const platformData = Object.keys(platforms).map(key => ({
                name: formatPlatform(key),
                value: platforms[key].total_texts
            }));
            
            if (platformData.length > 0) {
                const chart = echarts.init(document.getElementById('chartPlatform'));
                chart.setOption({
                    tooltip: { trigger: 'item' },
                    legend: { bottom: 0 },
                    series: [{
                        type: 'pie',
                        radius: '60%',
                        data: platformData,
                        itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 }
                    }]
                });
            }

            // å…³é”®è¯
            const keywords = result.keywords || [];
            if (keywords.length > 0) {
                const topKeywords = keywords.slice(0, 10).reverse();
                const chart = echarts.init(document.getElementById('chartKeywords'));
                chart.setOption({
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: { type: 'value' },
                    yAxis: { type: 'category', data: topKeywords.map(k => k.keyword) },
                    series: [{
                        type: 'bar',
                        data: topKeywords.map(k => k.weight),
                        itemStyle: { color: '#3b82f6', borderRadius: [0, 4, 4, 0] },
                        barWidth: '60%'
                    }]
                });
            }

            window.addEventListener('resize', () => {
                echarts.getInstanceByDom(document.getElementById('chartSentiment'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartTrend'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartPlatform'))?.resize();
                echarts.getInstanceByDom(document.getElementById('chartKeywords'))?.resize();
            });
        }

        function formatPlatform(key) {
            const map = { 'xhs': 'å°çº¢ä¹¦', 'douyin': 'æŠ–éŸ³', 'weibo': 'å¾®åš', 'zhihu': 'çŸ¥ä¹', 'bilibili': 'Bç«™' };
            return map[key] || key;
        }
    </script>
</body>
</html>