# 报表功能说明

## 概述

系统已增强分析结果功能，新增了丰富的分析维度和专业的报表生成功能。

## 新增分析维度

### 1. 情感分析增强

- **整体情感分析**：统计正面、负面、中性情感的比例和数量
- **按平台情感分析**：分析各平台（小红书、抖音、微博、知乎等）的情感分布
- **时间趋势分析**：分析情感随时间的变化趋势

### 2. 主题提取

- 自动提取文本中的主要主题
- 每个主题包含相关关键词和样本数量
- 支持主题权重排序

### 3. 平台统计

- 统计各平台的数据量
- 分析各平台的数据分布

### 4. 关键词分析

- 提取Top关键词（默认30个）
- 计算关键词权重（TF-IDF）
- 生成关键词权重图表

## 报表功能

### 报表类型

系统支持生成以下格式的报表：

- **HTML报表**：可在浏览器中直接查看，包含交互式图表
- **PDF报表**：适合打印和分享的专业格式

### 报表内容

报表包含以下章节：

1. **报告摘要**
   - 总文本数统计
   - 情感分布概览
   - 关键指标卡片

2. **情感分析**
   - 整体情感分布饼图
   - 各平台情感对比柱状图
   - 情感趋势折线图
   - 详细统计数据表

3. **关键词分析**
   - 关键词权重柱状图
   - Top关键词列表

4. **主题分析**
   - 主要主题列表
   - 主题相关关键词

5. **平台数据分布**
   - 各平台数据量统计
   - 平台分布图表

6. **AI深度洞察**
   - LLM生成的品牌分析报告
   - 品牌形象分析
   - 改进建议

7. **文本统计**
   - 文本数量统计
   - 高频词统计

## 使用方法

### 1. 启动分析任务

```python
POST /api/v1/brands/{brand_id}/analyze
{
    "analysis_type": "full",
    "include_sentiment": true,
    "include_topics": true,
    "include_keywords": true,
    "include_insights": true
}
```

### 2. 等待分析完成

分析任务会在后台异步执行，可以通过以下API查询任务状态：

```python
GET /api/v1/brands/{brand_id}/analysis
```

### 3. 生成报表

```python
POST /api/v1/brands/{brand_id}/reports
{
    "report_type": "full",
    "format": "pdf",  # 或 "html"
    "include_charts": true,
    "language": "zh-CN"
}
```

### 4. 下载报表

报表生成完成后，可以通过以下API下载：

```python
GET /api/v1/reports/{report_id}/download
```

## 报表模板

报表使用专业的HTML模板，支持：

- 响应式设计，适配不同屏幕尺寸
- 打印优化，适合PDF导出
- 美观的图表和数据表格
- 品牌化的样式设计

## 技术实现

### 图表生成

使用 `matplotlib` 生成以下类型的图表：

- 饼图：情感分布
- 柱状图：平台对比、关键词权重
- 折线图：时间趋势

图表以base64编码嵌入HTML，无需外部文件依赖。

### PDF生成

支持两种PDF生成方式：

1. **weasyprint**（推荐）：纯Python实现，支持CSS3
2. **pdfkit**（备选）：需要wkhtmltopdf

### 异步处理

报表生成使用Celery异步任务，不会阻塞API请求。

## 配置要求

### Python依赖

确保安装以下依赖：

```bash
pip install matplotlib jinja2 weasyprint numpy
```

### 中文字体

系统会自动尝试使用以下中文字体：

- SimHei（黑体）
- Microsoft YaHei（微软雅黑）
- Arial Unicode MS

如果图表中文显示异常，请确保系统安装了中文字体。

## 注意事项

1. **数据量**：大量数据可能需要较长时间生成报表
2. **PDF生成**：首次使用PDF功能可能需要安装额外依赖
3. **图表显示**：如果某些图表未生成，可能是数据不足或格式问题
4. **异步任务**：确保Celery worker正在运行

## 示例

完整的品牌分析和报表生成流程：

```python
# 1. 创建品牌
POST /api/v1/brands
{
    "name": "山四砂锅",
    "description": "传统砂锅品牌"
}

# 2. 启动爬取任务
POST /api/v1/brands/1/crawl
{
    "platforms": ["xhs", "douyin", "weibo"],
    "keywords": ["山四砂锅"],
    "max_items": 100
}

# 3. 等待爬取完成，然后启动分析
POST /api/v1/brands/1/analyze
{
    "analysis_type": "full"
}

# 4. 等待分析完成，然后生成报表
POST /api/v1/brands/1/reports
{
    "format": "pdf"
}

# 5. 下载报表
GET /api/v1/reports/{report_id}/download
```

## 未来改进

- [ ] 支持Excel格式导出
- [ ] 支持Word格式导出
- [ ] 自定义报表模板
- [ ] 报表定时生成
- [ ] 报表邮件发送
- [ ] 更多图表类型（词云图、热力图等）


